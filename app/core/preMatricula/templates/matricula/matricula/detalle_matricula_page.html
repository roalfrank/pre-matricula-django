{% extends 'base.html'%}
{% load static%}

{% block head %}
<link rel="stylesheet" href="{% static 'lib/datatables-1.10.20/css/dataTables.bootstrap4.min.css' %}" />
<link rel="stylesheet"
    href="{% static 'lib/datatables-1.10.20/plugins/responsive-2.2.3/css/responsive.bootstrap4.min.css' %}" />
{% endblock  %}

{% block titulo %}<img src="{% static 'img/iconos/curso.png' %}" alt="Fecha fin"
    style="width: 2.5rem; margin-right: 1rem;" srcset="">Detalle del Curso{%endblock%}
{%block contenido%}
<div class="cargar_matricula"></div>
{%endblock%}
{%block js%}
<script src="{% static 'lib/datatables-1.10.20/js/jquery.dataTables.js' %}"></script>
<script src="{% static 'lib/datatables-1.10.20/js/dataTables.bootstrap4.min.js' %}"></script>
<script src="{% static 'lib/datatables-1.10.20/plugins/responsive-2.2.3/js/dataTables.responsive.min.js' %}"></script>
<script src="{% static 'lib/datatables-1.10.20/plugins/responsive-2.2.3/js/responsive.bootstrap4.min.js' %}"></script>
<script>
    $(function () {
        let cargarDataTable = function () {
            //cargar datatable de comentario
            $('#tabla_comentario').DataTable({
                pageLength: 5,
                lengthMenu: [
                    [5, 10, 20, -1],
                    [5, 10, 20, "Todos"]
                ],
                "order": [],
                columnDefs: [{
                    targets: 0,
                    orderable: false,

                }]
            });
        }


        $('.cargar_matricula').load('{% url "prematricula:matricula-detalle" id_matricula %}', function () {
            $('[data-toggle="popover"]').popover({
                html: true,
                content: function () {
                    var content = $(this).attr("data-popover-content");
                    return $(content).children(".popover-body").html();
                },
                title: function () {
                    var title = $(this).attr("data-popover-content");
                    return $(title).children(".popover-heading").html();
                }
            });
            //cargar like
            $('#like_button').on('click', function (event) {
                var pk = $(this).attr('value');
                $.ajax({
                    type: 'POST',
                    url: '{% url "prematricula:matricula-like" %}',
                    data: {
                        'id_matricula': pk,
                        'csrfmiddlewaretoken': '{{ csrf_token }}'
                    },
                    datatype: 'json',
                    success: function (response) {
                        if (response["error"] == false) {
                            if (response['is_liked']) {
                                $('#like_button').removeClass('btn-default');
                                $('#like_button').addClass('btn-info');
                            } else {
                                $('#like_button').removeClass('btn-info');
                                $('#like_button').addClass('btn-default');
                            }
                            $('#cantidad_like').html(response['total_likes'])
                                .fadeIn(1000);

                        }


                    },
                    error: function (rs, e) {
                        console.log(rs.responseText);
                    },
                });
            });
            cargarDataTable();
            //el boton para matricular
            $('#btn-matricular').on('click', function (e) {
                let btn_matricular = $(this);
                //{% if request.user.groups.all.0.name == 'Estudiante' %}
                console.log(btn_matricular.attr('activo')=='si');
                if (btn_matricular.attr('activo') == 'si') {
                    $.ajax({
                        type: 'POST',
                        url: '{% url "prematricula:matricula-estudiante-add" %}',
                        data: {
                            'id_matricula':{{id_matricula}},
                            'action': 'delete',
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        datatype: 'json',
                        success: function (response) {
                            if (response["error"] == false) {
                                btn_matricular.removeClass('btn-danger');
                                btn_matricular.addClass('btn-default');
                                btn_matricular.html('<i class="fas fa-graduation-cap p-1"></i>Matricular');
                                btn_matricular.attr('activo', 'no');
                                mensaje('success','Eliminada su matrícula.');
                                $('#cant_estudante').html(response['cant_estudiante']);
                                let promedio = Math.round((response['cant_estudiante']*100)/ parseInt($('#cant_estudiante_total').text()));
                                $('#cant_estudiante_promedio').html(promedio +'%');
                                console.log(response);
                                $("#estado-matricula").html(response["estado"]);
                                $("#estado-matricula").removeClass('badge-success badge-danger badge-warning');
                                color = 'badge-success'
                                if(response["estado"]=='cerrado'){
                                  color = 'badge-danger'
                                }
                                else if (response["estado"]=='en proceso'){
                                    color = 'badge-warning'
                                }
                                $("#estado-matricula").addClass(color);
                                 $('.carousel-inner').load('{% url "prematricula:matricula-estudiante-listar-carrucel" id_matricula %}',function(){
                                 });
                            }
                            else{
                                 mensaje('error','Error eliminando su matrícula , contactar a un admin.');
                            }

                        },
                        error: function (rs, e) {
                            console.log(rs.responseText);
                        },
                    });
                } 
                else {
                    $.ajax({
                        type: 'POST',
                        url: '{% url "prematricula:matricula-estudiante-add" %}',
                        data: {
                            'id_matricula': {{id_matricula}},
                            'action': 'add',
                            'csrfmiddlewaretoken': '{{ csrf_token }}'
                        },
                        datatype: 'json',
                        success: function (response) {
                            if (response["error"] == false) {
                                btn_matricular.removeClass('btn-default');
                                btn_matricular.addClass('btn-danger');
                                btn_matricular.html('<i class="fa fa-trash-alt p-1"></i>Cancelar matrícula');
                                btn_matricular.attr('activo', 'si');
                                mensaje('success','Matriculado correctamente.');
                                $('#cant_estudante').html(response['cant_estudiante']);
                                let promedio = Math.round((response['cant_estudiante']*100)/ parseInt($('#cant_estudiante_total').text()));
                                $('#cant_estudiante_promedio').html(promedio +'%');
                                $("#estado-matricula").html(response["estado"]);
                                $("#estado-matricula").removeClass('badge-success badge-danger badge-warning');
                                color = 'badge-success'
                                if(response["estado"]=='cerrado'){
                                  color = 'badge-danger'
                                }
                                else if (response["estado"]=='en proceso'){
                                    color = 'badge-warning'
                                }
                                $("#estado-matricula").addClass(color);
                                 $('.carousel-inner').load('{% url "prematricula:matricula-estudiante-listar-carrucel" id_matricula %}',function(){
                                 });
                            }
                            else{
                                mensaje('error','Error en la matrícula , contactar a un admin.');
                            }


                        },
                        error: function (rs, e) {
                            console.log(rs.responseText);
                        },
                    });
                }
                //{% else %}
                btn_matricular.removeClass('btn-success');
                btn_matricular.removeClass('btn-default');
                btn_matricular.addClass('btn-secondary');
                btn_matricular.html('<i class="fas fa-plus mr-2"></i>No estudiante.');
                //{% endif %}

            });
            //evento del formulario comentario general
            $("#comentario-contenedor").on('submit', 'form', function (e) {
                e.preventDefault();
                console.log(e.target.texto.value);
                var parametro = new FormData(e.target);
                $.ajax({
                    type: 'POST',
                    url: '{% url "prematricula:comentario-add" %}',
                    data: parametro,
                    datatype: 'json',
                    processData: false,
                    contentType: false,
                    success: function (response) {
                        if (response["error"] == false) {
                            if (response['estudiante']) {
                                mensaje('succes',
                                    "Comentario enviado correctamente. ");
                            } else {
                                $("#cargarComentarios").load(
                                    '{% url "prematricula:comentario-listar" %}', {
                                        'id_matricula': {{id_matricula}},
                                        'csrfmiddlewaretoken': function () {
                                            return $(
                                                'input[name="csrfmiddlewaretoken"]'
                                            ).val();
                                        },
                                    },
                                    function () {
                                        cargarDataTable();
                                    });
                                mensaje("success",
                                    "Comentario enviado correctamente.");
                            }
                            e.target.texto.value = '';
                        } else {
                            mensaje("error", "Error mandando comentario. ");
                        }


                    },
                    error: function (rs, e) {
                        console.log(rs.responseText);
                    },
                }); //fin ajax
            });
            //formulario responder 

        });

    });
</script>
{%endblock%}